# MCP 能力场景说明

本文档描述在 GitLab CR AI Agent 中接入 MCP（Model Context Protocol）后，可实现的典型场景与价值。

---

## 1. AI 按需选择分析器（替代「全量跑 analyzers」）

**现状**：所有启用的 analyzers（ESLint、TypeScript 等）对每个 context 都会跑一遍。  
**MCP 化**：把每个 analyzer 暴露成 MCP tool，由 AI 根据「当前文件类型、语言、变更内容」决定要不要调用、调用哪个。

- **场景**：只有 `.ts` 改动用 `tsc`，只有样式改动用 `stylelint`，只有依赖改动用 `npm audit`，减少无效执行、加快 CR。
- **价值**：更省资源、更贴合变更范围。

---

## 2. 动态拉取仓库/项目上下文（超越「当前 hunk + 周围几行」）

**现状**：上下文主要是 diff + 周围几行，没有「按需查别的文件」。  
**MCP 化**：暴露「读文件」「列目录」「在目录内搜索」等 tools，AI 在审查时按需拉取相关代码。

- **场景**：改了一个 API → AI 主动查调用方、测试、文档；改了组件 → 查使用处和 story；改了配置 → 查引用该配置的地方。
- **价值**：评论更准、更少误报，能发现「调用链 / 测试 / 文档」不一致等问题。

---

## 3. 接入团队规范与文档（知识库 / RAG）

**现状**：规则主要写在静态 prompt/规则文件里，难以按需检索。  
**MCP 化**：用 MCP **resources** 暴露团队规范、API 文档、架构说明、CR 示例等；或做成「检索 + 返回片段」的 **tools**。

- **场景**：审查是否符合团队命名/分支规范、内部 API 约定、安全/隐私规范；参考历史类似 MR 的评论写法。
- **价值**：评论更一致、可落地，减少「泛泛建议」。

---

## 4. 和 GitLab 深度联动（MR / Issue / CI / 成员）

**现状**：只用 GitLab API 拉 diff、写评论。  
**MCP 化**：把 GitLab 能力封装成 MCP tools，例如：查 MR 列表/描述/标签、查关联 Issue、查 CI 状态、查项目成员/权限、查最近合并的 MR。

- **场景**：建议「MR 描述里关联 issue #123」「当前 pipeline 失败，建议先修 CI」「类似改动在 !456 里已有讨论可参考」。
- **价值**：评论从「只看代码」升级到「结合 MR/CI/协作信息」。

---

## 5. 依赖与安全（按变更按需扫描）

**现状**：若把 npm audit、license 检查做成 analyzer，一般是全量或按文件类型跑。  
**MCP 化**：把这些能力做成 MCP tools，AI 只在「发现依赖/锁文件/镜像配置变更」时调用。

- **场景**：改了 `package.json` / `yarn.lock` → 调用依赖/漏洞/许可证检查，并在评论里直接给出「升级 xxx 到 x.y.z 可修复」之类建议。
- **价值**：安全类评论更聚焦、可执行。

---

## 6. 测试与覆盖率（结合 CI 结果）

**现状**：不读测试结果或覆盖率。  
**MCP 化**：提供「查当前 MR 的测试结果/覆盖率/失败用例」的 tool（可从 CI 产物或本地报告解析）。

- **场景**：改了核心逻辑但测试未变或覆盖率下降 → 建议补测试或贴出失败用例；发现某条失败用例和当前改动相关 → 在对应行评论里提到。
- **价值**：把「要写测试 / 要修失败用例」从泛泛建议变成有依据、可定位。

---

## 7. 代码库检索（相似实现 / 历史 MR）

**现状**：不查历史代码或历史 MR。  
**MCP 化**：提供「语义搜索/关键词搜索」类 tool（或对接已有 RAG/向量检索），按「当前改动」检索相似实现或相似 MR。

- **场景**：发现与 `src/foo` 的写法不一致 → 建议统一；类似问题在 MR !456 已修过 → 建议参考；发现重复逻辑 → 建议抽公共方法。
- **价值**：减少重复、统一风格、复用历史经验。

---

## 8. 多轮/对话式 CR（未来扩展）

**现状**：单轮「diff in → comments out」。  
**MCP 化**：若以后支持「用户回复评论 → AI 再回复」，可暴露「查某条 discussion 的回复」「查 MR 最新 diff/commits」等 tools，让 AI 根据最新对话和最新代码继续审查。

- **场景**：用户说「这里不能改因为 xxx」→ AI 查相关讨论和最新 diff，再给出修正建议或关闭建议。
- **价值**：CR 变成可对话、可迭代。

---

## 优先级与落地建议

| 优先级 | 场景 | 说明 |
|--------|------|------|
| 高 | 1. AI 按需选 analyzers | 和现有 analyzers 直接结合，改造成 MCP tools 即可，收益明确 |
| 高 | 2. 动态仓库上下文 | 显著提升评论质量，需要「读文件/搜索」类 tools + 权限与安全设计 |
| 中 | 3. 团队规范/文档 | 依赖规范文档形态，可用 MCP resources 或简单检索 tool |
| 中 | 4. GitLab 深度联动 | 需要封装 GitLab API，适合「MR/CI/Issue 感知」的评论 |
| 中 | 5. 依赖与安全 | 适合在 1 之后做，按变更触发 npm audit 等 |
| 中 | 6. 测试/覆盖率 | 依赖 CI 产物或本地报告格式，可后续接 |
| 低 | 7. 代码库检索 | 需要检索/向量能力，可作为增强项 |
| 低 | 8. 多轮 CR | 依赖产品形态从「单轮」升级到「对话式」 |

---

## 相关文档

- [架构说明](./ARCHITECTURE.md)
- [Analyzers 扩展指南](../src/analyzers/README.md)
